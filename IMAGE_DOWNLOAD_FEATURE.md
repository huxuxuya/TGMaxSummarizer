# Функционал сохранения изображений из VK MAX

## Обзор

Добавлен функционал автоматического скачивания и сохранения изображений из сообщений VK MAX при загрузке сообщений в базу данных.

## Архитектура

### Компоненты

1. **ImageDownloader** (`shared/image_utils.py`) - основной класс для скачивания изображений
2. **ImageViewer** (`shared/image_viewer.py`) - утилита для просмотра и управления изображениями
3. **Обновленная модель Message** - добавлено поле `image_paths`
4. **Обновленная схема БД** - добавлено поле `image_paths` в таблицу `messages`

### Структура хранения

```
images/
└── chats/
    ├── chat_id_1/
    │   ├── chat_id_1_message_id_1_0_hash.jpg
    │   ├── chat_id_1_message_id_1_1_hash.png
    │   └── ...
    ├── chat_id_2/
    │   └── ...
    └── ...
```

## Функционал

### Автоматическое скачивание

- При загрузке сообщений из VK MAX автоматически извлекаются URL изображений
- Изображения скачиваются и сохраняются локально
- Пути к изображениям сохраняются в базе данных

### Поддерживаемые форматы

- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

### Обработка вложений VK MAX

Поддерживаются следующие типы вложений:
- `photo` - фотографии
- `image` - изображения
- `picture` - картинки

### Уникальные имена файлов

Формат имени файла: `{chat_id}_{message_id}_{index}_{hash}.{extension}`

- `chat_id` - ID чата VK MAX
- `message_id` - ID сообщения
- `index` - порядковый номер изображения в сообщении
- `hash` - MD5 хеш URL для уникальности
- `extension` - расширение файла

## API

### ImageDownloader

```python
from shared.image_utils import ImageDownloader

downloader = ImageDownloader()

# Извлечь URL изображений из вложений
image_urls = downloader.extract_image_urls(attachments)

# Скачать изображение
saved_path = await downloader.download_image(url, chat_id, message_id, index)

# Обработать все изображения в сообщении
saved_paths = await downloader.process_message_images(attachments, chat_id, message_id)
```

### ImageViewer

```python
from shared.image_viewer import ImageViewer

viewer = ImageViewer()

# Получить все изображения чата
images = viewer.get_chat_images(chat_id)

# Получить изображения конкретного сообщения
images = viewer.get_message_images(chat_id, message_id)

# Получить статистику
stats = viewer.get_image_stats()
```

## Интеграция

### В процессе загрузки сообщений

1. VK клиент загружает сообщения
2. `format_messages_for_db()` обрабатывает вложения
3. `ImageDownloader` скачивает изображения
4. Пути к изображениям добавляются в данные сообщения
5. Сообщения сохраняются в БД с путями к изображениям

### В модели данных

```python
class Message(BaseModel):
    # ... другие поля ...
    image_paths: List[str] = Field(default_factory=list)  # Пути к изображениям
```

## Миграция базы данных

Запустите миграцию для добавления нового поля:

```bash
python migrate_database.py
```

## Конфигурация

### Настройка папки для изображений

По умолчанию изображения сохраняются в папку `images/`. Можно изменить:

```python
downloader = ImageDownloader(base_path="custom_images_folder")
```

### Обработка ошибок

- Неудачные скачивания логируются, но не прерывают процесс
- Дублирующиеся файлы не скачиваются повторно
- Проверяется content-type для валидации изображений

## Производительность

### Оптимизации

- Асинхронное скачивание
- Проверка существования файлов перед скачиванием
- Пакетная обработка вложений
- Логирование для мониторинга

### Ограничения

- Максимальный размер файла ограничен настройками aiohttp
- Таймаут скачивания: стандартные настройки aiohttp
- Место на диске: зависит от количества и размера изображений

## Мониторинг

### Логирование

Все операции логируются с соответствующими уровнями:
- `INFO` - успешные операции
- `WARNING` - предупреждения (неизвестные типы вложений)
- `ERROR` - ошибки скачивания

### Статистика

```python
stats = viewer.get_image_stats()
# Возвращает:
# {
#     'total_images': 150,
#     'total_size': 52428800,  # в байтах
#     'chats_count': 5,
#     'size_mb': 50.0
# }
```

## Тестирование

Запустите тестовый скрипт:

```bash
python test_image_download.py
```

## Будущие улучшения

1. **Сжатие изображений** - автоматическое сжатие для экономии места
2. **Cloud storage** - интеграция с облачными хранилищами
3. **Кэширование** - кэш для часто используемых изображений
4. **Веб-интерфейс** - просмотр изображений через веб-интерфейс
5. **Анализ изображений** - интеграция с AI для анализа содержимого
